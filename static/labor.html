<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>Totoro</title>
        <style>
            iframe {
                width: 60px;
                height: 60px;
            }
        </style>
        <script src="/socket.io/socket.io.js"></script>
    </head>
    <body>
        <h1>Totoro</h1>
        <p>A simple, easy-to-use and stable front-end unit testing tool.</p>
        <script>
            (function() {
                if (typeof console === 'undefined') {
                    console = {
                        log : function() {
                        }
                    }
                }

                function Labor() {
                    this.orders = {}
                    this.reports = []
                    this.timer = undefined
                    this.init()
                }

                Labor.prototype.init = function() {
                    var that = this
                    var socket = this.socket = io.connect('/labor')
                    socket.on('connect', function() {
                        console.log('connected')
                        socket.emit('init', {
                            ua: navigator.userAgent
                        })
                    })

                    socket.on('ping', function() {
                        clearInterval(that.timer)
                    })

                    socket.on('add', function(data) {
                        that.add(data)
                    })

                    socket.on('remove', function(orderId) {
                        that.remove(orderId)
                    })

                    socket.on('reload', function() {
                        console.log('reload')
                        window.location.reload()
                    })

                    socket.on('disconnect', function() {
                        console.log('disconnected')
                        for (var i in that.orders) {
                            that.remove(i)
                        }
                        that.timer = setInterval(function() {
                            that.socket.emit('ping')
                        }, 950)
                    })

                    setInterval(function() {
                        if (that.reports.length) {
                            var data = that.reports
                            that.reports = []
                            that.socket.emit('report', data)
                        }
                    }, 1000)
                }

                Labor.prototype.add = function(data) {
                    var orderId = data.orderId
                    var path = data.path
                    var src = 'runner/' + data.orderId + path
                    var element = document.createElement('iframe')
                    element.src = src
                    element.id = orderId // TODO why ies need this?
                    document.body.appendChild(element)
                    this.orders[orderId] = element
                    console.log('add order: ' + orderId)
                }

                Labor.prototype.remove = function(orderId) {
                    var element = this.orders[orderId]

                    if (element){
                        delete this.orders[orderId]
                        /*
                         * NOTE:
                         *
                         * if removeChild() is not wrapped in setTimout()
                         * this method will cause error in ie9
                         * a very short time after iframe be removed
                         * test frameworks seems still working, cause unreasonable error and report it
                         *
                         * as report data was cached in JSON form
                         * these errors will change 'end' report's value
                         */
                        setTimeout(function() {
                            document.body.removeChild(element)
                        }, 0)
                        console.log('remove order: ' + orderId)
                    }
                }

                var labor = new Labor()
                window.report = function(data) {
                    if (data.action === 'end' && !data.info.error) {
                        var orderId = data.orderId
                        var orderEl = labor.orders[orderId].contentWindow
                        if(orderEl._$jscoverage) {
                            var cov = map(orderEl._$jscoverage)
                            ;delete cov.files
                            data.info.coverage = cov
                            console.log(cov)
                        }
                    }
                    labor.reports.push(data)
                    if (data.action === 'end') {
                        var orderId = data.orderId
                        console.log('finish order: ' + orderId)
                        labor.remove(orderId)
                    }
                }


                // the following code base on
                // https://github.com/visionmedia/mocha/blob/master/lib/reporters/json-cov.js

                /**
                 * Map jscoverage data to a JSON structure
                 * suitable for reporting.
                 *
                 * @param {Object} cov
                 * @return {Object}
                 * @api private
                 */
                function map(cov) {
                    var ret = {
                        sloc: 0,
                        hits: 0,
                        misses: 0,
                        coverage: 0,
                        files: []
                    }

                    for (var filename in cov) {
                        var data = coverage(filename, cov[filename])
                        ret.files.push(data)
                        ret.hits += data.hits
                        ret.misses += data.misses
                        ret.sloc += data.sloc
                    }

                    ret.files.sort(function(a, b) {
                        return a.filename.localeCompare(b.filename)
                    });

                    if (ret.sloc > 0) {
                        ret.coverage = (ret.hits / ret.sloc) * 100
                    }

                    return ret
                };

                /**
                 * Map jscoverage data for a single source file
                 * to a JSON structure suitable for reporting.
                 *
                 * @param {String} filename name of the source file
                 * @param {Object} data jscoverage coverage data
                 * @return {Object}
                 * @api private
                 */
                function coverage(filename, data) {
                    var ret = {
                        filename: filename,
                        coverage: 0,
                        hits: 0,
                        misses: 0,
                        sloc: 0,
                        source: {}
                    };

                    for (var i = 0; i < data.source.length; i++) {
                        var num = i
                        var line = data.source[i]

                        num++

                        if (data[num] === 0) {
                            ret.misses++
                            ret.sloc++
                        } else if (data[num] !== undefined) {
                            ret.hits++
                            ret.sloc++
                        }

                        ret.source[num] = {
                            source: line,
                            coverage: data[num] === undefined ? '' : data[num]
                        };
                    }

                    ret.coverage = ret.hits / ret.sloc * 100

                    return ret
                }

                /**
                 * Return a plain-object representation of `test`
                 * free of cyclic properties etc.
                 *
                 * @param {Object} test
                 * @return {Object}
                 * @api private
                 */
                function clean(test) {
                    return {
                        title: test.title,
                        fullTitle: test.fullTitle(),
                        duration: test.duration
                    }
                }

            })()
        </script>
    </body>
</html>
